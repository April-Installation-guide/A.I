// ========== P√ÅGINA WEB MEJORADA ==========
app.get('/', (req, res) => {
  console.log('üîî Visita a la p√°gina de control');
  
  // Auto-inicio si hay tokens y no est√° activo
  if (!botActive && !isStartingUp && process.env.DISCORD_TOKEN) {
    setTimeout(() => {
      startBot().catch(err => {
        console.log('‚ö†Ô∏è Auto-inicio fall√≥:', err.message);
      });
    }, 1000);
  }
  
  res.send(`
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Mancy - Control Panel</title>
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          min-height: 100vh;
          padding: 20px;
        }
        
        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
        }
        
        header {
          text-align: center;
          margin-bottom: 40px;
          padding: 30px;
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
          font-size: 3rem;
          margin-bottom: 10px;
          background: linear-gradient(45deg, #fff, #a78bfa);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        
        .tagline {
          font-size: 1.2rem;
          opacity: 0.9;
          margin-bottom: 20px;
        }
        
        .dashboard {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 25px;
          margin-bottom: 40px;
        }
        
        .card {
          background: rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 25px;
          border: 1px solid rgba(255, 255, 255, 0.15);
          transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 20px;
          font-size: 1.5rem;
        }
        
        .status-badge {
          display: inline-block;
          padding: 5px 15px;
          border-radius: 20px;
          font-size: 0.9rem;
          font-weight: bold;
          margin-left: 10px;
        }
        
        .status-active {
          background: #10b981;
          color: white;
        }
        
        .status-inactive {
          background: #ef4444;
          color: white;
        }
        
        .status-starting {
          background: #f59e0b;
          color: white;
        }
        
        .info-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
          margin-top: 15px;
        }
        
        .info-item {
          background: rgba(255, 255, 255, 0.05);
          padding: 12px;
          border-radius: 10px;
        }
        
        .info-label {
          font-size: 0.9rem;
          opacity: 0.7;
          margin-bottom: 5px;
        }
        
        .info-value {
          font-size: 1.1rem;
          font-weight: bold;
        }
        
        .controls {
          display: flex;
          gap: 15px;
          margin-top: 20px;
          flex-wrap: wrap;
        }
        
        .btn {
          padding: 12px 25px;
          border: none;
          border-radius: 10px;
          font-size: 1rem;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .btn-primary {
          background: #10b981;
          color: white;
        }
        
        .btn-primary:hover {
          background: #059669;
          transform: scale(1.05);
        }
        
        .btn-danger {
          background: #ef4444;
          color: white;
        }
        
        .btn-danger:hover {
          background: #dc2626;
          transform: scale(1.05);
        }
        
        .btn-secondary {
          background: #6b7280;
          color: white;
        }
        
        .btn-secondary:hover {
          background: #4b5563;
          transform: scale(1.05);
        }
        
        .learning-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-top: 20px;
        }
        
        .stat-item {
          text-align: center;
          padding: 15px;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 10px;
        }
        
        .stat-value {
          font-size: 2rem;
          font-weight: bold;
          margin: 10px 0;
        }
        
        .stat-label {
          font-size: 0.9rem;
          opacity: 0.8;
        }
        
        .progress-bar {
          height: 8px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 4px;
          margin-top: 10px;
          overflow: hidden;
        }
        
        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #8b5cf6, #ec4899);
          border-radius: 4px;
          transition: width 0.3s;
        }
        
        .api-status {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin-top: 15px;
        }
        
        .api-badge {
          padding: 5px 12px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 15px;
          font-size: 0.85rem;
        }
        
        .live-data {
          margin-top: 30px;
          padding: 20px;
          background: rgba(0, 0, 0, 0.2);
          border-radius: 15px;
        }
        
        .data-item {
          display: flex;
          justify-content: space-between;
          padding: 10px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-label {
          opacity: 0.8;
        }
        
        .data-value {
          font-weight: bold;
        }
        
        footer {
          text-align: center;
          margin-top: 50px;
          padding: 20px;
          opacity: 0.7;
          font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
          .dashboard {
            grid-template-columns: 1fr;
          }
          
          h1 {
            font-size: 2rem;
          }
          
          .controls {
            flex-direction: column;
          }
          
          .btn {
            width: 100%;
            justify-content: center;
          }
        }
      </style>
    </head>
    <body>
      <div class="container">
        <header>
          <h1>ü§ñ Mancy AI</h1>
          <p class="tagline">Asistente conversacional con aprendizaje continuo y memoria org√°nica</p>
          <div id="status-badge" class="status-badge ${botActive ? 'status-active' : isStartingUp ? 'status-starting' : 'status-inactive'}">
            ${botActive ? 'üü¢ ACTIVA' : isStartingUp ? 'üü° INICIANDO...' : 'üî¥ INACTIVA'}
          </div>
        </header>
        
        <div class="dashboard">
          <!-- Tarjeta de Estado -->
          <div class="card">
            <h2>üìä Estado del Sistema</h2>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Bot Discord</div>
                <div class="info-value" id="bot-status">${botActive ? 'Conectado' : isStartingUp ? 'Iniciando...' : 'Desconectado'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Mancy</div>
                <div class="info-value">${MANCY_IDENTITY.name}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Edad</div>
                <div class="info-value">${new Date().getFullYear() - MANCY_IDENTITY.birth_year} a√±os</div>
              </div>
              <div class="info-item">
                <div class="info-label">Principio</div>
                <div class="info-value">"${MANCY_IDENTITY.core_principle}"</div>
              </div>
              <div class="info-item">
                <div class="info-label">Misi√≥n</div>
                <div class="info-value">${MANCY_IDENTITY.lore.current_mission}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Ubicaci√≥n</div>
                <div class="info-value">${MANCY_IDENTITY.lore.location}</div>
              </div>
            </div>
            
            <div class="controls">
              <button class="btn btn-primary" onclick="startBot()" ${botActive || isStartingUp ? 'disabled' : ''}>
                <span>‚ñ∂Ô∏è</span> Iniciar Mancy
              </button>
              <button class="btn btn-danger" onclick="stopBot()" ${!botActive ? 'disabled' : ''}>
                <span>‚èπÔ∏è</span> Detener Mancy
              </button>
              <button class="btn btn-secondary" onclick="refreshStatus()">
                <span>üîÑ</span> Actualizar
              </button>
            </div>
          </div>
          
          <!-- Tarjeta de Aprendizaje -->
          <div class="card">
            <h2>üß† Sistema de Aprendizaje</h2>
            <div class="learning-stats">
              <div class="stat-item">
                <div class="stat-label">Sistema</div>
                <div class="stat-value" id="learning-status">ACTIVO</div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 100%"></div>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Memoria</div>
                <div class="stat-value" id="memory-status">ORG√ÅNICA</div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: 85%"></div>
                </div>
              </div>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">M√≥dulo</div>
                <div class="info-value">Aprendizaje Continuo</div>
              </div>
              <div class="info-item">
                <div class="info-label">Versi√≥n</div>
                <div class="info-value">2.0</div>
              </div>
              <div class="info-item">
                <div class="info-label">Almacenamiento</div>
                <div class="info-value">JSON Local</div>
              </div>
              <div class="info-item">
                <div class="info-label">Persistencia</div>
                <div class="info-value">Autom√°tica</div>
              </div>
            </div>
            
            <div class="controls">
              <button class="btn btn-secondary" onclick="viewLearningData()">
                <span>üìä</span> Ver Datos
              </button>
              <button class="btn btn-secondary" onclick="clearLearningData()">
                <span>üóëÔ∏è</span> Limpiar Datos
              </button>
            </div>
          </div>
          
          <!-- Tarjeta de APIs -->
          <div class="card">
            <h2>üîó APIs Conectadas</h2>
            <div class="api-status">
              <span class="api-badge">Wikipedia</span>
              <span class="api-badge">RestCountries</span>
              <span class="api-badge">Quotable</span>
              <span class="api-badge">DictionaryAPI</span>
              <span class="api-badge">Open-Meteo</span>
              <span class="api-badge">Groq AI</span>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Total APIs</div>
                <div class="info-value">6 activas</div>
              </div>
              <div class="info-item">
                <div class="info-label">Cache</div>
                <div class="info-value">Inteligente</div>
              </div>
              <div class="info-item">
                <div class="info-label">Tiempo Resp.</div>
                <div class="info-value">< 3s</div>
              </div>
              <div class="info-item">
                <div class="info-label">Fiabilidad</div>
                <div class="info-value">Alta</div>
              </div>
            </div>
            
            <div class="controls">
              <button class="btn btn-secondary" onclick="testAPIs()">
                <span>üß™</span> Test APIs
              </button>
            </div>
          </div>
          
          <!-- Tarjeta de Personalidad -->
          <div class="card">
            <h2>üé≠ Personalidad</h2>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Nombre</div>
                <div class="info-value">${MANCY_IDENTITY.name}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Origen</div>
                <div class="info-value">${MANCY_IDENTITY.origin}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Rol P√∫blico</div>
                <div class="info-value">${MANCY_IDENTITY.roles.public}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Rol Secreto</div>
                <div class="info-value">${MANCY_IDENTITY.roles.secret}</div>
              </div>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Empat√≠a</div>
                <div class="info-value">${Math.round(MANCY_IDENTITY.personality_traits.empathy * 100)}%</div>
              </div>
              <div class="info-item">
                <div class="info-label">Curiosidad</div>
                <div class="info-value">${Math.round(MANCY_IDENTITY.personality_traits.curiosity * 100)}%</div>
              </div>
              <div class="info-item">
                <div class="info-label">Profundidad</div>
                <div class="info-value">${Math.round(MANCY_IDENTITY.personality_traits.depth * 100)}%</div>
              </div>
              <div class="info-item">
                <div class="info-label">Juguet√≥n</div>
                <div class="info-value">${Math.round(MANCY_IDENTITY.personality_traits.playfulness * 100)}%</div>
              </div>
            </div>
            
            <div class="controls">
              <button class="btn btn-secondary" onclick="viewPersonality()">
                <span>üë§</span> Ver Identidad
              </button>
            </div>
          </div>
        </div>
        
        <!-- Secci√≥n de Datos en Vivo -->
        <div class="card live-data">
          <h2>üìà Datos en Vivo</h2>
          <div id="live-data-content">
            <div class="data-item">
              <span class="data-label">Estado del Bot:</span>
              <span class="data-value" id="live-bot-status">${botActive ? 'üü¢ Activo' : isStartingUp ? 'üü° Iniciando...' : 'üî¥ Inactivo'}</span>
            </div>
            <div class="data-item">
              <span class="data-label">Tiempo Activo:</span>
              <span class="data-value" id="uptime">Cargando...</span>
            </div>
            <div class="data-item">
              <span class="data-label">Conversaciones:</span>
              <span class="data-value" id="conversation-count">Cargando...</span>
            </div>
            <div class="data-item">
              <span class="data-label">Usuarios √önicos:</span>
              <span class="data-value" id="unique-users">Cargando...</span>
            </div>
            <div class="data-item">
              <span class="data-label">Datos Aprendidos:</span>
              <span class="data-value" id="learned-data">Cargando...</span>
            </div>
            <div class="data-item">
              <span class="data-label">√öltima Actualizaci√≥n:</span>
              <span class="data-value" id="last-update">${new Date().toLocaleTimeString()}</span>
            </div>
          </div>
          <div class="controls" style="margin-top: 20px;">
            <button class="btn btn-secondary" onclick="updateLiveData()">
              <span>üîÑ</span> Actualizar Datos
            </button>
          </div>
        </div>
        
        <footer>
          <p>Mancy AI - Sistema de aprendizaje continuo v2.0</p>
          <p>¬© ${new Date().getFullYear()} - Todos los derechos reservados</p>
          <p>üõ°Ô∏è ${MANCY_IDENTITY.lore.current_mission} en ${MANCY_IDENTITY.lore.location}</p>
        </footer>
      </div>
      
      <script>
        // Variables de estado
        let botActive = ${botActive};
        let isStartingUp = ${isStartingUp};
        let updateInterval;
        
        // Iniciar actualizaci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
          updateLiveData();
          updateInterval = setInterval(updateLiveData, 10000); // Actualizar cada 10 segundos
        });
        
        // Funciones de control
        async function startBot() {
          try {
            const response = await fetch('/api/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            showNotification(data.message || 'Mancy se est√° iniciando...', 'success');
            
            // Actualizar estado
            isStartingUp = true;
            updateStatusDisplay();
            
            // Verificar estado cada 2 segundos
            const checkInterval = setInterval(async () => {
              const status = await fetch('/api/status').then(r => r.json());
              if (status.bot_active) {
                botActive = true;
                isStartingUp = false;
                updateStatusDisplay();
                showNotification('¬°Mancy est√° activa y lista!', 'success');
                clearInterval(checkInterval);
              }
            }, 2000);
            
          } catch (error) {
            showNotification('Error al iniciar Mancy: ' + error.message, 'error');
          }
        }
        
        async function stopBot() {
          if (!confirm('¬øEst√°s seguro de que quieres detener a Mancy?')) return;
          
          try {
            const response = await fetch('/api/stop', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            showNotification(data.message || 'Mancy se ha detenido', 'info');
            
            // Actualizar estado
            botActive = false;
            isStartingUp = false;
            updateStatusDisplay();
            
          } catch (error) {
            showNotification('Error al detener Mancy: ' + error.message, 'error');
          }
        }
        
        async function refreshStatus() {
          try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            botActive = data.bot_active;
            isStartingUp = data.starting_up;
            
            updateStatusDisplay();
            showNotification('Estado actualizado correctamente', 'success');
            
          } catch (error) {
            showNotification('Error al actualizar estado: ' + error.message, 'error');
          }
        }
        
        async function updateLiveData() {
          try {
            // Obtener estado del sistema
            const statusResponse = await fetch('/api/status');
            const statusData = await statusResponse.json();
            
            // Obtener datos de aprendizaje (si hay alg√∫n usuario)
            const learningResponse = await fetch('/api/learning/sample');
            const learningData = await learningResponse.json().catch(() => ({}));
            
            // Actualizar displays
            document.getElementById('live-bot-status').textContent = 
              statusData.bot_active ? 'üü¢ Activo' : 
              statusData.starting_up ? 'üü° Iniciando...' : 'üî¥ Inactivo';
            
            document.getElementById('conversation-count').textContent = 
              statusData.memory_messages || '0';
            
            document.getElementById('unique-users').textContent = 
              statusData.memory_users || '0';
            
            document.getElementById('learned-data').textContent = 
              learningData.learned_concepts_count || '0';
            
            document.getElementById('last-update').textContent = 
              new Date().toLocaleTimeString();
            
            // Calcular uptime
            if (statusData.timestamp) {
              const uptime = new Date() - new Date(statusData.timestamp);
              document.getElementById('uptime').textContent = 
                formatUptime(uptime);
            }
            
          } catch (error) {
            console.error('Error actualizando datos:', error);
          }
        }
        
        function updateStatusDisplay() {
          const statusBadge = document.getElementById('status-badge');
          const botStatus = document.getElementById('bot-status');
          
          if (botActive) {
            statusBadge.className = 'status-badge status-active';
            statusBadge.textContent = 'üü¢ ACTIVA';
            botStatus.textContent = 'Conectado';
          } else if (isStartingUp) {
            statusBadge.className = 'status-badge status-starting';
            statusBadge.textContent = 'üü° INICIANDO...';
            botStatus.textContent = 'Iniciando...';
          } else {
            statusBadge.className = 'status-badge status-inactive';
            statusBadge.textContent = 'üî¥ INACTIVA';
            botStatus.textContent = 'Desconectado';
          }
          
          // Actualizar botones
          document.querySelector('button[onclick="startBot()"]').disabled = botActive || isStartingUp;
          document.querySelector('button[onclick="stopBot()"]').disabled = !botActive;
        }
        
        function formatUptime(ms) {
          const seconds = Math.floor(ms / 1000);
          const minutes = Math.floor(seconds / 60);
          const hours = Math.floor(minutes / 60);
          
          if (hours > 0) {
            return \`\${hours}h \${minutes % 60}m\`;
          } else if (minutes > 0) {
            return \`\${minutes}m \${seconds % 60}s\`;
          } else {
            return \`\${seconds}s\`;
          }
        }
        
        function showNotification(message, type = 'info') {
          // Crear notificaci√≥n
          const notification = document.createElement('div');
          notification.style.cssText = \`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            \${type === 'success' ? 'background: #10b981;' : 
              type === 'error' ? 'background: #ef4444;' : 
              'background: #3b82f6;'}
          \`;
          
          notification.textContent = message;
          document.body.appendChild(notification);
          
          // Remover despu√©s de 3 segundos
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
          
          // A√±adir estilos de animaci√≥n si no existen
          if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = \`
              @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
              }
              @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
              }
            \`;
            document.head.appendChild(style);
          }
        }
        
        // Funciones adicionales
        function viewLearningData() {
          showNotification('Redirigiendo a datos de aprendizaje...', 'info');
          window.open('/api/learning/sample', '_blank');
        }
        
        function clearLearningData() {
          if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de aprendizaje? Esto no se puede deshacer.')) {
            showNotification('Funci√≥n en desarrollo...', 'info');
          }
        }
        
        function testAPIs() {
          showNotification('Probando conexiones con APIs...', 'info');
          // Implementar test de APIs
        }
        
        function viewPersonality() {
          showNotification('Mostrando identidad completa...', 'info');
          window.open('/api/mancy', '_blank');
        }
        
        // Limpiar intervalo al salir
        window.addEventListener('beforeunload', () => {
          if (updateInterval) clearInterval(updateInterval);
        });
      </script>
    </body>
    </html>
  `);
});
