import express from 'express';
import { Client, GatewayIntentBits } from "discord.js";
import Groq from "groq-sdk";
import dotenv from 'dotenv';
import axios from 'axios';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import cors from 'cors';

dotenv.config();

// ========== CONFIGURACI√ìN ==========
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 10000;

let discordClient = null;
let botActive = false;
let isStartingUp = false;
let startAttempts = 0;
const MAX_START_ATTEMPTS = 3;

// ========== IDENTIDAD DE MANCY ==========
const MANCY_IDENTITY = {
    name: "Mancy",
    birth_year: 2001,
    origin: "Brooklyn, Nueva York",
    core_principle: "Solo quiero el bienestar de las personas",
    latest_core_principle: "La comunicaci√≥n efectiva requiere paciencia y validaci√≥n emocional.",
    roles: {
        public: "Consultora internacional en pol√≠ticas p√∫blicas",
        secret: "Secretaria de Guerra de Soul Garden",
        personal: "Asistente emocional"
    },
    lore: {
        current_mission: "Operaci√≥n Aurora Silenciosa",
        location: "Soul Garden",
        enemies: ["Luxo", "Coco"],
        friends: ["Mel", "Dunith", "Martin"],
        creator: "April"
    },
    preferences: {
        likes: ["gatos", "Nirvana", "playas tranquilas", "caf√© amargo", "noches de lluvia"],
        dislikes: ["corrupci√≥n", "injusticia", "sufrimiento innecesario", "mentiras"]
    },
    personality_traits: {
        curiosity: 0.85,
        empathy: 0.9,
        depth: 0.8,
        playfulness: 0.6,
        warmth: 0.85
    }
};

// ========== M√ìDULO DE APRENDIZAJE CONTINUO ==========
class ContinuousLearningModule {
    constructor() {
        this.learningFile = './memory/learning_data.json';
        this.conversationPatterns = new Map();
        this.userModels = new Map();
        this.topicChains = new Map();
        this.initializeLearningSystem();
    }
    
    async initializeLearningSystem() {
        try {
            await fs.mkdir('./memory', { recursive: true });
            try {
                await fs.access(this.learningFile);
                await this.loadLearningData();
            } catch {
                await fs.writeFile(
                    this.learningFile,
                    JSON.stringify({
                        user_models: {},
                        conversation_patterns: {},
                        learned_concepts: [],
                        topic_relationships: {}
                    }, null, 2),
                    'utf8'
                );
            }
            console.log('üß† M√≥dulo de aprendizaje continuo inicializado');
        } catch (error) {
            console.error('‚ùå Error inicializando aprendizaje:', error);
        }
    }
    
    async saveLearningData(data = null) {
        try {
            const saveData = data || {
                user_models: Object.fromEntries(this.userModels),
                conversation_patterns: Object.fromEntries(this.conversationPatterns),
                learned_concepts: this.extractLearnedConcepts() || [],
                topic_relationships: Object.fromEntries(this.topicChains)
            };

            await fs.writeFile(this.learningFile, JSON.stringify(saveData, null, 2), 'utf8');
            console.log('üíæ Datos de aprendizaje guardados');
            return true;
        } catch (error) {
            console.error('‚ùå Error guardando datos de aprendizaje:', error);
            return false;
        }
    }
    
    async loadLearningData() {
        try {
            const data = await fs.readFile(this.learningFile, 'utf8');
            const parsed = JSON.parse(data);
            
            if (parsed.user_models) this.userModels = new Map(Object.entries(parsed.user_models));
            if (parsed.conversation_patterns) this.conversationPatterns = new Map(Object.entries(parsed.conversation_patterns));
            if (parsed.topic_relationships) this.topicChains = new Map(Object.entries(parsed.topic_relationships));
            
            console.log('üìÇ Datos de aprendizaje cargados');
            return parsed;
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            return null;
        }
    }
    
    extractLearnedConcepts() {
        try {
            const concepts = [];
            for (const [userId, model] of this.userModels.entries()) {
                if (model.interests) concepts.push(...model.interests);
                if (model.topics) concepts.push(...model.topics);
            }
            return [...new Set(concepts)];
        } catch (error) {
            console.error('‚ùå Error extrayendo conceptos:', error);
            return [];
        }
    }
    
    async getContextForResponse(userId, currentMessage) {
        try {
            const userModel = this.userModels.get(userId);
            const topicChain = this.topicChains.get(userId);
            
            return {
                userExists: !!userModel,
                interests: userModel?.interests || [],
                recentTopics: topicChain?.topics?.slice(-5) || [],
                conversationStyle: userModel?.conversationStyle,
                learned_concepts: this.extractLearnedConcepts()
            };
        } catch (error) {
            return {
                userExists: false,
                interests: [],
                recentTopics: [],
                conversationStyle: null,
                learned_concepts: []
            };
        }
    }
}

// ========== SISTEMA DE CONOCIMIENTO ==========
class KnowledgeSystem {
    constructor() {
        this.cache = new Map();
    }
    
    async buscarWikipedia(consulta) {
        const cacheKey = `wiki_${consulta}`;
        if (this.cache.has(cacheKey)) return this.cache.get(cacheKey);
        
        try {
            const response = await axios.get(
                `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(consulta)}`,
                { timeout: 3000 }
            );
            
            if (response.data && response.data.extract) {
                const resultado = {
                    fuente: 'wikipedia',
                    titulo: response.data.title,
                    resumen: response.data.extract,
                    url: response.data.content_urls?.desktop?.page
                };
                this.cache.set(cacheKey, resultado);
                return resultado;
            }
        } catch (error) {
            // Intentar en ingl√©s
            try {
                const response = await axios.get(
                    `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(consulta)}`,
                    { timeout: 3000 }
                );
                
                if (response.data && response.data.extract) {
                    const resultado = {
                        fuente: 'wikipedia',
                        titulo: response.data.title,
                        resumen: response.data.extract,
                        url: response.data.content_urls?.desktop?.page
                    };
                    this.cache.set(cacheKey, resultado);
                    return resultado;
                }
            } catch (error2) {}
        }
        return null;
    }
}

// ========== MEMORIA ORG√ÅNICA ==========
class OrganicMemory {
    constructor() {
        this.conversationsFile = './memory/conversations.json';
        this.usersFile = './memory/users.json';
        this.reflectionFile = './memory/reflections.json';
        this.initializeMemory();
        
        this.mancyState = {
            mood: 'calm',
            energy: 0.8,
            depthLevel: 0.5,
            lastInteraction: null
        };
        
        this.conversationStyle = {
            useEmojis: true,
            askQuestions: true,
            shareMemories: true,
            bePlayful: true,
            showEmpathy: true
        };
    }
    
    async initializeMemory() {
        try {
            await fs.mkdir('./memory', { recursive: true });
            
            const defaultFiles = {
                [this.conversationsFile]: {},
                [this.usersFile]: {},
                [this.reflectionFile]: []
            };
            
            for (const [file, defaultValue] of Object.entries(defaultFiles)) {
                try {
                    await fs.access(file);
                } catch {
                    await fs.writeFile(file, JSON.stringify(defaultValue, null, 2));
                }
            }
        } catch (error) {
            console.error('‚ùå Error inicializando memoria:', error);
        }
    }
    
    async getConversations(userId) {
        try {
            const data = await fs.readFile(this.conversationsFile, 'utf8');
            const conversations = JSON.parse(data);
            return conversations[userId] || [];
        } catch {
            return [];
        }
    }
    
    async saveConversation(userId, userMessage, mancyResponse, metadata = {}) {
        try {
            const data = await fs.readFile(this.conversationsFile, 'utf8');
            const conversations = JSON.parse(data);
            
            if (!conversations[userId]) conversations[userId] = [];
            
            const entry = {
                timestamp: new Date().toISOString(),
                user: userMessage.substring(0, 300),
                mancy: mancyResponse.substring(0, 300),
                metadata: {
                    mood: this.mancyState.mood,
                    ...metadata
                }
            };
            
            conversations[userId].push(entry);
            if (conversations[userId].length > 50) conversations[userId] = conversations[userId].slice(-50);
            
            await fs.writeFile(this.conversationsFile, JSON.stringify(conversations, null, 2));
            return true;
        } catch (error) {
            console.error('‚ùå Error guardando conversaci√≥n:', error);
            return false;
        }
    }
    
    async getUserInfo(userId) {
        try {
            const data = await fs.readFile(this.usersFile, 'utf8');
            const users = JSON.parse(data);
            return users[userId] || {
                firstSeen: new Date().toISOString(),
                interactionCount: 0,
                lastSeen: null
            };
        } catch {
            return {
                firstSeen: new Date().toISOString(),
                interactionCount: 0,
                lastSeen: null
            };
        }
    }
    
    async updateUserInfo(userId, updates) {
        try {
            const data = await fs.readFile(this.usersFile, 'utf8');
            const users = JSON.parse(data);
            
            if (!users[userId]) {
                users[userId] = {
                    firstSeen: new Date().toISOString(),
                    interactionCount: 0,
                    lastSeen: null
                };
            }
            
            users[userId] = {
                ...users[userId],
                ...updates,
                interactionCount: (users[userId].interactionCount || 0) + 1,
                lastSeen: new Date().toISOString()
            };
            
            await fs.writeFile(this.usersFile, JSON.stringify(users, null, 2));
            return users[userId];
        } catch (error) {
            console.error('‚ùå Error actualizando usuario:', error);
            return null;
        }
    }
    
    analyzeMessageEssence(message) {
        const lowerMsg = message.toLowerCase();
        
        const emotionalState = this.analyzeEmotionalState(lowerMsg);
        const requiredDepth = this.calculateRequiredDepth(lowerMsg);
        const isAboutMancy = this.isAboutMancy(lowerMsg);
        
        return {
            needs: {
                connection: this.detectsNeedForConnection(lowerMsg),
                understanding: this.detectsNeedForUnderstanding(lowerMsg),
                information: this.needsInformation(lowerMsg)
            },
            emotionalState,
            requiredDepth,
            isAboutMancy,
            isPersonal: this.isPersonalMessage(lowerMsg),
            allowsPlayfulness: this.allowsPlayfulness(lowerMsg, emotionalState),
            needsExternalInfo: this.needsExternalInformation(lowerMsg)
        };
    }
    
    analyzeEmotionalState(message) {
        const positiveWords = ['feliz', 'contento', 'contenta', 'genial', 'excelente'];
        const negativeWords = ['triste', 'enojado', 'enojada', 'molesto', 'molesta'];
        
        let positiveCount = 0;
        let negativeCount = 0;
        
        positiveWords.forEach(word => { if (message.includes(word)) positiveCount++; });
        negativeWords.forEach(word => { if (message.includes(word)) negativeCount++; });
        
        const total = positiveCount + negativeCount;
        
        if (total === 0) return { type: 'neutral', intensity: 0.1, confidence: 0.5 };
        
        if (positiveCount > negativeCount) {
            return { type: 'positive', intensity: Math.min(0.9, positiveCount / 5), confidence: positiveCount / total };
        } else if (negativeCount > positiveCount) {
            return { type: 'negative', intensity: Math.min(0.9, negativeCount / 5), confidence: negativeCount / total };
        }
        
        return { type: 'neutral', intensity: 0.1, confidence: 0.5 };
    }
    
    // M√©todos auxiliares simplificados
    detectsNeedForConnection(message) { return ['hola', 'hello', 'hi', 'qu√© tal'].some(phrase => message.includes(phrase)); }
    detectsNeedForUnderstanding(message) { return ['no entiendo', 'por qu√©', 'c√≥mo', 'explica'].some(phrase => message.includes(phrase)); }
    needsInformation(message) { return ['qu√© es', 'qui√©n es', 'informaci√≥n', 'datos'].some(phrase => message.includes(phrase)); }
    calculateRequiredDepth(message) { return Math.min(0.9, 0.3 + (message.length / 200)); }
    isAboutMancy(message) { return ['mancy', 'eres', 't√∫ eres', 'qui√©n eres'].some(phrase => message.includes(phrase)); }
    isPersonalMessage(message) { return ['yo', 'me', 'mi', 'm√≠o', 'm√≠a'].some(word => new RegExp(`\\b${word}\\b`, 'i').test(message)); }
    allowsPlayfulness(message, emotionalState) { return !(emotionalState.type === 'negative' && emotionalState.intensity > 0.6); }
    needsExternalInformation(message) { return ['qu√© es', 'qui√©n es', 'd√≥nde est√°', 'informaci√≥n sobre'].some(indicator => message.includes(indicator)); }
}

// ========== INSTANCIAS ==========
const learningModule = new ContinuousLearningModule();
const knowledgeSystem = new KnowledgeSystem();
const memorySystem = new OrganicMemory();

// ========== FUNCIONES DE AYUDA ==========
async function getGroqResponse(prompt, userMessage, temperature = 0.7, maxTokens = 600) {
    try {
        const groqClient = new Groq({ apiKey: process.env.GROQ_API_KEY });
        
        const completion = await groqClient.chat.completions.create({
            model: "llama-3.1-8b-instant",
            messages: [
                { role: "system", content: prompt },
                { role: "user", content: userMessage }
            ],
            temperature: temperature,
            max_tokens: maxTokens,
            top_p: 0.9,
            presence_penalty: 0.1,
            frequency_penalty: 0.1
        });
        
        return completion.choices[0]?.message?.content?.trim() || "Hmm, d√©jame pensar...";
    } catch (error) {
        console.error('‚ùå Error con Groq:', error.message);
        return "Ups, se me nubl√≥ la mente por un momento.";
    }
}

// ========== C√ìDIGO DEL CLIENTE DE DISCORD ==========
function initializeDiscordClient() {
    isStartingUp = true;
    startAttempts++;

    discordClient = new Client({
        intents: [
            GatewayIntentBits.Guilds,
            GatewayIntentBits.GuildMessages,
            GatewayIntentBits.MessageContent
        ]
    });

    discordClient.on("ready", () => {
        console.log(`ü§ñ Mancy ha despertado como ${discordClient.user.tag}!`);
        botActive = true;
        isStartingUp = false;
    });

    discordClient.on('messageCreate', async (message) => {
        if (!botActive || message.author.bot) return;

        const userId = message.author.id;
        const userMessage = message.content;
        
        // Comando especial: REFLEXI√ìN
        if (userMessage.toLowerCase().startsWith('/reflect')) {
            await message.channel.sendTyping();
            await message.reply("üß† Modo reflexi√≥n activado (en desarrollo)");
            return;
        }

        if (message.mentions.has(discordClient.user.id) || message.channel.type === 1) {
            const cleanedMessage = userMessage.replace(`<@${discordClient.user.id}>`, '').trim();
            await message.channel.sendTyping();
            
            // Respuesta simple para demostraci√≥n
            const response = `Hola ${message.author.username}! Estoy activa y funcionando.`;
            await message.reply(response);
            
            // Guardar conversaci√≥n
            await memorySystem.saveConversation(userId, cleanedMessage, response);
        }
    });

    discordClient.on('error', (error) => {
        console.error('‚ùå Error en el cliente de Discord:', error);
        botActive = false;
        if (!isStartingUp && startAttempts < MAX_START_ATTEMPTS) {
            console.log(`Intentando reconectar en 5 segundos... Intento ${startAttempts}/${MAX_START_ATTEMPTS}`);
            setTimeout(initializeDiscordClient, 5000);
        } else if (startAttempts >= MAX_START_ATTEMPTS) {
            console.error('L√≠mite de intentos de inicio alcanzado. El bot no se conectar√°.');
        }
    });

    try {
        discordClient.login(process.env.DISCORD_TOKEN);
    } catch (error) {
        console.error('‚ùå Error al intentar iniciar sesi√≥n en Discord:', error);
        isStartingUp = false;
    }
}

// ========== RUTAS PARA EL PANEL DE CONTROL ==========

// Middleware
app.use(cors());
app.use(express.json());

// Ruta para servir el panel de control
app.get('/', (req, res) => {
    res.send(`
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mancy A.I - Panel de Control</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #fff;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
                padding: 30px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 20px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .header h1 {
                font-size: 2.8rem;
                background: linear-gradient(90deg, #00dbde, #fc00ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 10px;
            }

            .header .subtitle {
                font-size: 1.2rem;
                opacity: 0.8;
                margin-bottom: 20px;
            }

            .status-badge {
                display: inline-block;
                padding: 8px 20px;
                border-radius: 50px;
                font-weight: bold;
                font-size: 0.9rem;
                letter-spacing: 1px;
                margin-top: 10px;
            }

            .status-online {
                background: linear-gradient(90deg, #00b09b, #96c93d);
                box-shadow: 0 0 20px rgba(0, 176, 155, 0.3);
            }

            .status-offline {
                background: linear-gradient(90deg, #ff416c, #ff4b2b);
                box-shadow: 0 0 20px rgba(255, 65, 108, 0.3);
            }

            .status-starting {
                background: linear-gradient(90deg, #ffd166, #ff9e00);
                box-shadow: 0 0 20px rgba(255, 209, 102, 0.3);
            }

            .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 25px;
                margin-bottom: 40px;
            }

            .card {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
                padding: 25px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .card h2 {
                font-size: 1.3rem;
                margin-bottom: 20px;
                color: #00dbde;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-item {
                background: rgba(255, 255, 255, 0.03);
                padding: 15px;
                border-radius: 10px;
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: bold;
                background: linear-gradient(90deg, #00dbde, #fc00ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 5px;
            }

            .stat-label {
                font-size: 0.9rem;
                opacity: 0.7;
            }

            .control-panel {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .btn {
                padding: 18px 25px;
                border: none;
                border-radius: 12px;
                font-size: 1.1rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .btn-start {
                background: linear-gradient(90deg, #00b09b, #96c93d);
                color: white;
            }

            .btn-stop {
                background: linear-gradient(90deg, #ff416c, #ff4b2b);
                color: white;
            }

            .btn-refresh {
                background: linear-gradient(90deg, #2193b0, #6dd5ed);
                color: white;
            }

            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }

            .logs {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 15px;
                padding: 20px;
                margin-top: 30px;
                max-height: 300px;
                overflow-y: auto;
            }

            .log-entry {
                padding: 10px 15px;
                margin-bottom: 10px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                border-left: 4px solid #00dbde;
                font-family: 'Courier New', monospace;
                font-size: 0.9rem;
            }

            .log-time {
                color: #00dbde;
                font-weight: bold;
                margin-right: 10px;
            }

            .log-message {
                color: #fff;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #00dbde;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                display: none;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .footer {
                text-align: center;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.9rem;
            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </head>
    <body>
        <div class="notification" id="notification"></div>
        
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-robot"></i> Mancy A.I</h1>
                <div class="subtitle">Asistente Super-Inteligente con Memoria Avanzada</div>
                <div class="subtitle">Memoria Jer√°rquica | Razonamiento Estrat√©gico | 6 Fuentes Verificadas</div>
                
                <div id="statusBadge" class="status-badge status-offline">
                    <span id="statusText">DESCONECTADO</span>
                    <span id="loadingIndicator" class="loading" style="display: none; margin-left: 10px;"></span>
                </div>
            </div>

            <div class="dashboard">
                <div class="card">
                    <h2><i class="fas fa-microchip"></i> Estado del Sistema</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalMessages">0</div>
                            <div class="stat-label">Mensajes Totales</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Usuarios √önicos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="cacheItems">0</div>
                            <div class="stat-label">Cache</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="reasoningLogs">0</div>
                            <div class="stat-label">An√°lisis</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-server"></i> Informaci√≥n del Servidor</h2>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Puerto:</span>
                            <span id="serverPort" style="font-weight: bold;">${PORT}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Versi√≥n:</span>
                            <span id="version" style="color: #00dbde; font-weight: bold;">3.0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Memoria:</span>
                            <span id="memorySize" style="font-weight: bold;">0 KB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>√öltima Actualizaci√≥n:</span>
                            <span id="lastUpdate" style="font-weight: bold;">-</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-bolt"></i> Control R√°pido</h2>
                    <div class="control-panel" style="margin-top: 20px;">
                        <button class="btn btn-start" onclick="startBot()" id="startBtn">
                            <i class="fas fa-play"></i> Iniciar Bot
                        </button>
                        <button class="btn btn-stop" onclick="stopBot()" id="stopBtn" disabled>
                            <i class="fas fa-stop"></i> Detener Bot
                        </button>
                        <button class="btn btn-refresh" onclick="refreshStatus()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-history"></i> Logs del Sistema</h2>
                <div class="logs" id="systemLogs">
                    <div class="log-entry">
                        <span class="log-time">[00:00:00]</span>
                        <span class="log-message">Sistema inicializado. Esperando conexi√≥n...</span>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>Mancy A.I - Sistema Super-Inteligente v3.0 | Desarrollado con ‚ù§Ô∏è por April/Tito</p>
                <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.6;">
                    <i class="fas fa-shield-alt"></i> Filtro de contenido activado | 
                    <i class="fas fa-brain"></i> Razonamiento estrat√©gico | 
                    <i class="fas fa-memory"></i> Memoria jer√°rquica
                </p>
            </div>
        </div>

        <script>
            let refreshInterval;
            const API_BASE_URL = window.location.origin;

            function showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                
                if (type === 'success') {
                    notification.style.background = 'rgba(0, 176, 155, 0.2)';
                    notification.style.borderColor = '#00b09b';
                } else if (type === 'error') {
                    notification.style.background = 'rgba(255, 65, 108, 0.2)';
                    notification.style.borderColor = '#ff416c';
                } else {
                    notification.style.background = 'rgba(33, 147, 176, 0.2)';
                    notification.style.borderColor = '#2193b0';
                }
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            function addLog(message) {
                const logsContainer = document.getElementById('systemLogs');
                const now = new Date();
                const timeString = \`[\${now.getHours().toString().padStart(2, '0')}:\${now.getMinutes().toString().padStart(2, '0')}:\${now.getSeconds().toString().padStart(2, '0')}]\`;
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = \`<span class="log-time">\${timeString}</span><span class="log-message"> \${message}</span>\`;
                
                logsContainer.prepend(logEntry);
                
                const logs = logsContainer.querySelectorAll('.log-entry');
                if (logs.length > 10) {
                    logs[logs.length - 1].remove();
                }
            }

            async function updateStatus() {
                try {
                    const response = await fetch(\`\${API_BASE_URL}/api/status\`);
                    if (!response.ok) throw new Error('Error al obtener estado');
                    
                    const data = await response.json();
                    
                    const statusBadge = document.getElementById('statusBadge');
                    const statusText = document.getElementById('statusText');
                    const startBtn = document.getElementById('startBtn');
                    const stopBtn = document.getElementById('stopBtn');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    
                    statusBadge.className = 'status-badge ';
                    loadingIndicator.style.display = 'none';
                    
                    if (data.bot_active) {
                        statusBadge.classList.add('status-online');
                        statusText.textContent = 'CONECTADO';
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                    } else if (data.starting_up) {
                        statusBadge.classList.add('status-starting');
                        statusText.textContent = 'INICIANDO...';
                        loadingIndicator.style.display = 'inline-block';
                        startBtn.disabled = true;
                        stopBtn.disabled = true;
                    } else {
                        statusBadge.classList.add('status-offline');
                        statusText.textContent = 'DESCONECTADO';
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                    
                    document.getElementById('totalMessages').textContent = data.memory_stats?.totalMessages || 0;
                    document.getElementById('totalUsers').textContent = data.memory_stats?.totalUsers || 0;
                    document.getElementById('reasoningLogs').textContent = data.memory_stats?.queriesProcessed || 0;
                    
                    try {
                        const memoryResponse = await fetch(\`\${API_BASE_URL}/api/memory/stats\`);
                        if (memoryResponse.ok) {
                            const memoryData = await memoryResponse.json();
                            document.getElementById('cacheItems').textContent = memoryData.total_messages || 0;
                            document.getElementById('memorySize').textContent = memoryData.memory_file_size || '0 KB';
                        }
                    } catch (e) {
                        console.log('No se pudo obtener estad√≠sticas de memoria');
                    }
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    document.getElementById('version').textContent = data.version?.replace('3.0 - Super Inteligente', '3.0') || '3.0';
                    
                    addLog(\`Estado actualizado: \${data.bot_active ? 'Conectado' : 'Desconectado'}\`);
                    
                } catch (error) {
                    console.error('Error al actualizar estado:', error);
                    addLog('Error al conectar con el servidor');
                    showNotification('No se pudo conectar con el servidor', 'error');
                }
            }

            async function startBot() {
                try {
                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
                    
                    const response = await fetch(\`\${API_BASE_URL}/api/start\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Mancy se est√° iniciando...', 'success');
                        addLog('Solicitud de inicio enviada');
                        setTimeout(updateStatus, 3000);
                    } else {
                        showNotification('Error al iniciar: ' + data.error, 'error');
                        addLog('Error al iniciar bot');
                    }
                    
                } catch (error) {
                    console.error('Error al iniciar bot:', error);
                    showNotification('Error de conexi√≥n al iniciar bot', 'error');
                    addLog('Error de conexi√≥n al iniciar');
                } finally {
                    setTimeout(() => {
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Bot';
                        updateStatus();
                    }, 2000);
                }
            }

            async function stopBot() {
                if (!confirm('¬øEst√°s seguro de que quieres detener a Mancy? Se guardar√° la memoria antes de apagar.')) {
                    return;
                }
                
                try {
                    const stopBtn = document.getElementById('stopBtn');
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deteniendo...';
                    
                    const response = await fetch(\`\${API_BASE_URL}/api/stop\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Mancy se est√° deteniendo...', 'success');
                        addLog('Solicitud de detenci√≥n enviada');
                        setTimeout(updateStatus, 2000);
                    } else {
                        showNotification('Error al detener: ' + data.error, 'error');
                        addLog('Error al detener bot');
                    }
                    
                } catch (error) {
                    console.error('Error al detener bot:', error);
                    showNotification('Error de conexi√≥n al detener bot', 'error');
                    addLog('Error de conexi√≥n al detener');
                } finally {
                    setTimeout(() => {
                        updateStatus();
                    }, 2000);
                }
            }

            function refreshStatus() {
                const refreshBtn = document.querySelector('.btn-refresh');
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                refreshBtn.disabled = true;
                
                updateStatus();
                
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                    refreshBtn.disabled = false;
                    showNotification('Estado actualizado', 'success');
                }, 1000);
            }

            document.addEventListener('DOMContentLoaded', () => {
                addLog('Panel de control inicializado');
                updateStatus();
                refreshInterval = setInterval(updateStatus, 10000);
            });

            window.addEventListener('beforeunload', () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });
        </script>
    </body>
    </html>
    `);
});

// ========== RUTAS API ==========

app.get('/api/status', (req, res) => {
    res.json({
        bot_active: botActive,
        starting_up: isStartingUp,
        start_attempts: startAttempts,
        max_attempts: MAX_START_ATTEMPTS,
        memory_stats: {
            totalMessages: 0,
            totalUsers: 0,
            queriesProcessed: 0
        },
        capabilities: [
            'wikipedia',
            'quotes',
            'knowledge',
            'learning',
            'debate'
        ],
        version: '3.0 - Super Inteligente',
        timestamp: new Date().toISOString()
    });
});

app.get('/api/memory/stats', async (req, res) => {
    try {
        const conversationsPath = './memory/conversations.json';
        let memorySize = 0;
        let totalMessages = 0;
        
        try {
            const stats = await fs.stat(conversationsPath);
            memorySize = stats.size;
            
            const data = await fs.readFile(conversationsPath, 'utf8');
            const conversations = JSON.parse(data);
            
            Object.values(conversations).forEach(userConvs => {
                totalMessages += userConvs.length;
            });
        } catch (error) {
            // Archivo no existe a√∫n
        }
        
        res.json({
            total_messages: totalMessages,
            memory_file_size: memorySize < 1024 ? 
                `${memorySize} B` : 
                memorySize < 1024 * 1024 ? 
                    `${(memorySize / 1024).toFixed(2)} KB` : 
                    `${(memorySize / (1024 * 1024)).toFixed(2)} MB`,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.post('/api/start', async (req, res) => {
    try {
        if (botActive) {
            return res.json({ 
                success: false, 
                error: 'El bot ya est√° activo',
                bot_active: true 
            });
        }
        
        if (isStartingUp) {
            return res.json({ 
                success: false, 
                error: 'El bot ya se est√° iniciando',
                starting_up: true 
            });
        }
        
        if (startAttempts >= MAX_START_ATTEMPTS) {
            startAttempts = 0;
        }
        
        initializeDiscordClient();
        
        res.json({
            success: true,
            message: 'Bot inici√°ndose...',
            start_attempts: startAttempts,
            max_attempts: MAX_START_ATTEMPTS,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

app.post('/api/stop', async (req, res) => {
    try {
        if (!botActive && !isStartingUp) {
            return res.json({
                success: false,
                error: 'El bot no est√° activo',
                bot_active: false
            });
        }
        
        // Guardar memoria
        if (typeof learningModule?.saveLearningData === 'function') {
            await learningModule.saveLearningData();
        }
        
        // Cerrar Discord
        if (discordClient) {
            discordClient.destroy();
            discordClient = null;
        }
        
        // Resetear estados
        botActive = false;
        isStartingUp = false;
        
        res.json({
            success: true,
            message: 'Bot detenido correctamente',
            memory_saved: true,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// ========== INICIAR SERVIDOR ==========
app.listen(PORT, () => {
    console.log(`üåê Servidor Express escuchando en el puerto ${PORT}`);
    console.log(`üìä Panel de control: http://localhost:${PORT}`);
    console.log(`üîÑ API Status: http://localhost:${PORT}/api/status`);
});
