<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mancy A.I - Panel de Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.9rem;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .status-online {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            box-shadow: 0 0 20px rgba(0, 176, 155, 0.3);
        }

        .status-offline {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.3);
        }

        .status-starting {
            background: linear-gradient(90deg, #ffd166, #ff9e00);
            box-shadow: 0 0 20px rgba(255, 209, 102, 0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #00dbde;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            font-size: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .btn {
            padding: 18px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-start {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }

        .btn-refresh {
            background: linear-gradient(90deg, #2193b0, #6dd5ed);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .apis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .api-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .api-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .api-icon {
            font-size: 1.5rem;
            color: #00dbde;
        }

        .api-name {
            font-weight: bold;
        }

        .api-status {
            margin-left: auto;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00b09b;
        }

        .api-status.offline {
            background: #ff416c;
        }

        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #00dbde;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-time {
            color: #00dbde;
            font-weight: bold;
            margin-right: 10px;
        }

        .log-message {
            color: #fff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00dbde;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Mancy A.I</h1>
            <div class="subtitle">Asistente Super-Inteligente con Memoria Avanzada</div>
            <div class="subtitle">Memoria Jerárquica | Razonamiento Estratégico | 6 Fuentes Verificadas</div>
            
            <div id="statusBadge" class="status-badge status-offline">
                <span id="statusText">DESCONECTADO</span>
                <span id="loadingIndicator" class="loading" style="display: none; margin-left: 10px;"></span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-microchip"></i> Estado del Sistema</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">Mensajes Totales</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Usuarios Únicos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cacheItems">0</div>
                        <div class="stat-label">Cache</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="reasoningLogs">0</div>
                        <div class="stat-label">Análisis</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-server"></i> Información del Servidor</h2>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Puerto:</span>
                        <span id="serverPort" style="font-weight: bold;">10000</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Versión:</span>
                        <span id="version" style="color: #00dbde; font-weight: bold;">3.0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Memoria:</span>
                        <span id="memorySize" style="font-weight: bold;">0 MB</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Última Actualización:</span>
                        <span id="lastUpdate" style="font-weight: bold;">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-bolt"></i> Control Rápido</h2>
                <div class="control-panel" style="margin-top: 20px;">
                    <button class="btn btn-start" onclick="startBot()" id="startBtn">
                        <i class="fas fa-play"></i> Iniciar Bot
                    </button>
                    <button class="btn btn-stop" onclick="stopBot()" id="stopBtn" disabled>
                        <i class="fas fa-stop"></i> Detener Bot
                    </button>
                    <button class="btn btn-refresh" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-database"></i> Fuentes de Conocimiento</h2>
            <div class="apis-grid" id="apisList">
                <!-- Las APIs se cargarán dinámicamente -->
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-history"></i> Logs del Sistema</h2>
            <div class="logs" id="systemLogs">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span>
                    <span class="log-message">Sistema inicializado. Esperando conexión...</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Mancy A.I - Sistema Super-Inteligente v3.0 | Desarrollado con ❤️ por April/Tito</p>
            <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.6;">
                <i class="fas fa-shield-alt"></i> Filtro de contenido activado | 
                <i class="fas fa-brain"></i> Razonamiento estratégico | 
                <i class="fas fa-memory"></i> Memoria jerárquica
            </p>
        </div>
    </div>

    <script>
        let refreshInterval;
        const API_BASE_URL = window.location.origin;

        // Mostrar notificación
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = 'rgba(0, 176, 155, 0.2)';
                notification.style.borderColor = '#00b09b';
            } else if (type === 'error') {
                notification.style.background = 'rgba(255, 65, 108, 0.2)';
                notification.style.borderColor = '#ff416c';
            } else {
                notification.style.background = 'rgba(33, 147, 176, 0.2)';
                notification.style.borderColor = '#2193b0';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Añadir log al sistema
        function addLog(message) {
            const logsContainer = document.getElementById('systemLogs');
            const now = new Date();
            const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">${timeString}</span><span class="log-message"> ${message}</span>`;
            
            logsContainer.prepend(logEntry);
            
            // Mantener máximo 10 logs
            const logs = logsContainer.querySelectorAll('.log-entry');
            if (logs.length > 10) {
                logs[logs.length - 1].remove();
            }
        }

        // Actualizar estado del sistema
        async function updateStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/status`);
                if (!response.ok) throw new Error('Error al obtener estado');
                
                const data = await response.json();
                
                // Actualizar estado del bot
                const statusBadge = document.getElementById('statusBadge');
                const statusText = document.getElementById('statusText');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const loadingIndicator = document.getElementById('loadingIndicator');
                
                statusBadge.className = 'status-badge ';
                loadingIndicator.style.display = 'none';
                
                if (data.bot_active) {
                    statusBadge.classList.add('status-online');
                    statusText.textContent = 'CONECTADO';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else if (data.starting_up) {
                    statusBadge.classList.add('status-starting');
                    statusText.textContent = 'INICIANDO...';
                    loadingIndicator.style.display = 'inline-block';
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                } else {
                    statusBadge.classList.add('status-offline');
                    statusText.textContent = 'DESCONECTADO';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
                
                // Actualizar estadísticas
                document.getElementById('totalMessages').textContent = data.memory_stats?.totalMessages || 0;
                document.getElementById('totalUsers').textContent = data.memory_stats?.totalUsers || 0;
                document.getElementById('reasoningLogs').textContent = data.memory_stats?.queriesProcessed || 0;
                
                // Obtener estadísticas de memoria
                try {
                    const memoryResponse = await fetch(`${API_BASE_URL}/api/memory/stats`);
                    if (memoryResponse.ok) {
                        const memoryData = await memoryResponse.json();
                        document.getElementById('cacheItems').textContent = memoryData.total_messages || 0;
                        document.getElementById('memorySize').textContent = memoryData.memory_file_size || '0 MB';
                    }
                } catch (e) {
                    console.log('No se pudo obtener estadísticas de memoria');
                }
                
                // Actualizar fuentes de conocimiento
                updateApisList(data.capabilities || []);
                
                // Actualizar timestamp
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Actualizar versión
                document.getElementById('version').textContent = data.version?.replace('3.0 - Super Inteligente', '3.0') || '3.0';
                
                addLog(`Estado actualizado: ${data.bot_active ? 'Conectado' : 'Desconectado'}`);
                
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                addLog('Error al conectar con el servidor');
                showNotification('No se pudo conectar con el servidor', 'error');
            }
        }

        // Actualizar lista de APIs
        function updateApisList(capabilities) {
            const apisList = document.getElementById('apisList');
            const apis = [
                { name: 'Wikipedia ES/EN', icon: 'fas fa-book', status: 'online' },
                { name: 'RestCountries', icon: 'fas fa-globe-americas', status: 'online' },
                { name: 'PoetryDB', icon: 'fas fa-feather-alt', status: 'online' },
                { name: 'Quotable', icon: 'fas fa-quote-right', status: 'online' },
                { name: 'DictionaryAPI', icon: 'fas fa-book-open', status: 'online' },
                { name: 'Open-Meteo', icon: 'fas fa-cloud-sun', status: 'online' }
            ];
            
            apisList.innerHTML = apis.map(api => `
                <div class="api-item">
                    <i class="${api.icon} api-icon"></i>
                    <span class="api-name">${api.name}</span>
                    <div class="api-status ${api.status}"></div>
                </div>
            `).join('');
        }

        // Iniciar bot
        async function startBot() {
            try {
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
                
                const response = await fetch(`${API_BASE_URL}/api/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Mancy se está iniciando...', 'success');
                    addLog('Solicitud de inicio enviada');
                    
                    // Actualizar estado después de 3 segundos
                    setTimeout(updateStatus, 3000);
                } else {
                    showNotification('Error al iniciar: ' + data.error, 'error');
                    addLog('Error al iniciar bot');
                }
                
            } catch (error) {
                console.error('Error al iniciar bot:', error);
                showNotification('Error de conexión al iniciar bot', 'error');
                addLog('Error de conexión al iniciar');
            } finally {
                setTimeout(() => {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Bot';
                    updateStatus();
                }, 2000);
            }
        }

        // Detener bot
        async function stopBot() {
            if (!confirm('¿Estás seguro de que quieres detener a Mancy? Se guardará la memoria antes de apagar.')) {
                return;
            }
            
            try {
                const stopBtn = document.getElementById('stopBtn');
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deteniendo...';
                
                const response = await fetch(`${API_BASE_URL}/api/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Mancy se está deteniendo...', 'success');
                    addLog('Solicitud de detención enviada');
                    
                    // Actualizar estado después de 2 segundos
                    setTimeout(updateStatus, 2000);
                } else {
                    showNotification('Error al detener: ' + data.error, 'error');
                    addLog('Error al detener bot');
                }
                
            } catch (error) {
                console.error('Error al detener bot:', error);
                showNotification('Error de conexión al detener bot', 'error');
                addLog('Error de conexión al detener');
            } finally {
                setTimeout(() => {
                    updateStatus();
                }, 2000);
            }
        }

        // Refrescar estado
        function refreshStatus() {
            const refreshBtn = document.querySelector('.btn-refresh');
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
            refreshBtn.disabled = true;
            
            updateStatus();
            
            setTimeout(() => {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                refreshBtn.disabled = false;
                showNotification('Estado actualizado', 'success');
            }, 1000);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Panel de control inicializado');
            updateStatus();
            
            // Actualizar cada 10 segundos
            refreshInterval = setInterval(updateStatus, 10000);
            
            // Detectar si estamos en localhost o Render
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('serverPort').textContent = '10000 (localhost)';
            } else {
                document.getElementById('serverPort').textContent = window.location.port || '80/443 (Render)';
            }
        });

        // Limpiar intervalo al salir
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
